--- backup/factory\RepoFactoryMock.cls
+++ refactored/factory\RepoFactoryMock.cls
@@ -72 +71,0 @@
-IHistoryRepositoryrepo;
@@ -75 +74 @@
-List<FieldLevelHistory>historyRecords=HistoryResults.get(SObjectType);
+List<FieldLevelHistory>historyRecords=HistoryResults.get(sObjectType);
@@ -77,7 +76,7 @@
-if(
-queriedResults.size()>0||
-aggRecords?.size()>0||
-historyRecords?.size()>0||
-cursorResults?.size()>0||
-alwaysUseMock==true
-){
+BooleanhasMockData=queriedResults.isEmpty()==false||
+(aggRecords!=null&&aggRecords.isEmpty()==false)||
+(historyRecords!=null&&historyRecords.isEmpty()==false)||
+(cursorResults!=null&&cursorResults.isEmpty()==false);
+if(!hasMockData&&!alwaysUseMock){
+return(IHistoryRepository)fallback;
+}
@@ -92,5 +91 @@
-repo=mock;
-}else{
-repo=(IHistoryRepository)fallback;
-}
-returnrepo;
+returnmock;

--- backup/repository\AggregateRepository.cls
+++ refactored/repository\AggregateRepository.cls
@@ -138 +138,3 @@
-if(this.groupedByFieldNames.isEmpty()==false){
+if(this.groupedByFieldNames.isEmpty()){
+returnbaseString;
+}
@@ -145,5 +147 @@
-baseString+='\nGROUPBY';
-for(GroupBygroupBy:this.groupedByFieldNames){
-baseString+=groupBy.getGroupByName()+',';
-}
-baseString=baseString.removeEnd(',');
+baseString+=getGroupByClause();
@@ -151 +149 @@
-baseString+='\nHAVING'+String.join(this.havingFields,',');
+baseString+='\nHAVING'+String.join(newList<String>(this.havingFields),',');
@@ -155,0 +154 @@
+returnbaseString;
@@ -157 +156,6 @@
-returnbaseString;
+privateStringgetGroupByClause(){
+List<String>names=newList<String>();
+for(GroupBygroupBy:this.groupedByFieldNames){
+names.add(groupBy.getGroupByName());
+}
+return'\nGROUPBY'+String.join(names,',');

--- backup/repository\Query.cls
+++ refactored/repository\Query.cls
@@ -189 +189,13 @@
-StringstartingString=this.toString();
+StringstartingString=replaceBindVarsInSosl(this.toString());
+if(this.predicateinstanceofIterable<Object>){
+startingString=handleIterableOperator(startingString);
+if(String.isEmpty(startingString)){
+return'';
+}
+}
+if(startingString.endsWith(EMPTYISH_STRING)){
+this.isSoslEmpty=true;
+}
+returnstartingString;
+}
+privateStringreplaceBindVarsInSosl(Stringinput){
@@ -191,3 +203,5 @@
-startingString=startingString.replace(':'+key,this.getSoslPredicate(this.bindVars.get(key)));
-}
-if(this.predicateinstanceofIterable<Object>){
+input=input.replace(':'+key,this.getSoslPredicate(this.bindVars.get(key)));
+}
+returninput;
+}
+privateStringhandleIterableOperator(Stringinput){
@@ -211,7 +225,3 @@
-startingString=startingString.replace(operatorToReplace,newOperator);
-}
-}
-if(startingString.endsWith(EMPTYISH_STRING)){
-this.isSoslEmpty=true;
-}
-returnstartingString;
+returninput.replace(operatorToReplace,newOperator);
+}
+returninput;
@@ -286,6 +296,14 @@
-}elseif(predicateinstanceofDatetime){
-Datetimedt=(Datetime)predicate;
-returndt.format('yyyy-MM-dd\'T\'HH:mm:ss\'Z\'','GreenwichMeanTime');
-}elseif(predicateinstanceofIterable<Object>){
-Iterable<Object>localPredicates=(Iterable<Object>)predicate;
-if(localPredicates.iterator().hasNext()==false){
+}
+if(predicateinstanceofDatetime){
+return((Datetime)predicate).format('yyyy-MM-dd\'T\'HH:mm:ss\'Z\'','GreenwichMeanTime');
+}
+if(predicateinstanceofIterable<Object>){
+returnformatIterableSosl((Iterable<Object>)predicate);
+}
+if(predicateinstanceofString){
+return'\''+String.escapeSingleQuotes((String)predicate)+'\'';
+}
+returnString.valueOf(predicate);
+}
+privateStringformatIterableSosl(Iterable<Object>predicates){
+if(predicates.iterator().hasNext()==false){
@@ -295,14 +313,6 @@
-for(ObjectinnerPred:localPredicates){
-StringinnerString=this.getSoslPredicate(innerPred);
-innerStrings.add(innerString);
-}
-Stringstart='(';
-Stringending=')';
-returnstart+String.join(innerStrings,',')+ending;
-}elseif(predicateinstanceofString){
-Stringinput=(String)predicate;
-return'\''+String.escapeSingleQuotes(input)+'\'';
-}
-returnString.valueOf(predicate);
-}
-}
+for(ObjectinnerPred:predicates){
+innerStrings.add(this.getSoslPredicate(innerPred));
+}
+return'('+String.join(innerStrings,',')+')';
+}
+}

--- backup/repository\Repository.cls
+++ refactored/repository\Repository.cls
@@ -173,0 +174,21 @@
+for(Queryquery:optionalWhereFilters){
+this.childBindVarKeys.addAll(query.getBindVars().keySet());
+}
+StringrelationshipName=this.childToRelationshipNames.get(childFieldToken);
+StringchildFieldsToAdd=buildChildQuery(
+childFieldToken,
+childFields,
+optionalWhereFilters,
+fieldToSortOrder,
+limitBy
+);
+this.relationshipNameToChildQuery.put(relationshipName,childFieldsToAdd);
+returnthis;
+}
+privateStringbuildChildQuery(
+Schema.SObjectFieldchildFieldToken,
+List<QueryField>childFields,
+List<Query>optionalWhereFilters,
+Map<String,RepositorySortOrder>fieldToSortOrder,
+IntegerlimitBy
+){
@@ -184,5 +205 @@
-for(Queryquery:optionalWhereFilters){
-this.childBindVarKeys.addAll(query.getBindVars().keySet());
-}
-StringrelationshipName=this.childToRelationshipNames.get(childFieldToken);
-StringchildFieldsToAdd=String.format(
+returnString.format(
@@ -190,4 +207,2 @@
-newList<String>{String.join(childFieldNames,','),this.childToRelationshipNames.get(childFieldToken)}
-);
-this.relationshipNameToChildQuery.put(relationshipName,childFieldsToAdd);
-returnthis;
+newList<String>{String.join(newList<String>(childFieldNames),','),this.childToRelationshipNames.get(childFieldToken)}
+);
@@ -266 +281 @@
-return'SELECT'+String.join(localSelectFields,',')+'\nFROM'+this.repoType;
+return'SELECT'+String.join(newList<String>(localSelectFields),',')+'\nFROM'+this.repoType;
@@ -349 +364 @@
-String.join(this.addSelectFields(soslObject.selectFields),',')+
+String.join(newList<String>(this.addSelectFields(soslObject.selectFields)),',')+