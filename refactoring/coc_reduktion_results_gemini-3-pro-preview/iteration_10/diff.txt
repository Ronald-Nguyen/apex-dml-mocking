--- backup/factory\RepoFactoryMock.cls
+++ refactored/factory\RepoFactoryMock.cls
@@ -33,14 +33 @@
-List<Schema.ChildRelationship>childRelationships=CACHED_CHILD_RELATIONSHIPS.get(record.getSObjectType());
-if(childRelationships==null){
-childRelationships=record.getSObjectType()
-.getDescribe(Schema.SObjectDescribeOptions.FULL)
-.getChildRelationships();
-CACHED_CHILD_RELATIONSHIPS.put(record.getSObjectType(),childRelationships);
-}
-StringrelationshipName;
-for(Schema.ChildRelationshipchildRelationship:childRelationships){
-if(childRelationship.getField()==childField){
-relationshipName=childRelationship.getRelationshipName();
-break;
-}
-}
+StringrelationshipName=getRelationshipName(record,childField);
@@ -48,4 +35 @@
-StringserializedMeta=JSON.serialize(record).removeEnd('}');
-StringchildrenJson='"'+relationshipName+'":'+JSON.serialize(newChildrenSObjects(children));
-serializedMeta+=','+childrenJson+'}';
-return(SObject)JSON.deserialize(serializedMeta,SObject.class);
+returnappendChildren(record,relationshipName,children);
@@ -72,25 +56,4 @@
-IHistoryRepositoryrepo;
-List<SObject>queriedResults=getResults(sObjectType);
-List<AggregateRecord>aggRecords=AggregateResults.get(sObjectType);
-List<FieldLevelHistory>historyRecords=HistoryResults.get(SObjectType);
-List<Cursor>cursorResults=CursorResults.get(sObjectType);
-if(
-queriedResults.size()>0||
-aggRecords?.size()>0||
-historyRecords?.size()>0||
-cursorResults?.size()>0||
-alwaysUseMock==true
-){
-RepoMockmock=newRepoMock(sObjectType,repoFactory);
-mock.results.addAll(queriedResults);
-if(aggRecords!=null){
-mock.aggRecords.addAll(aggRecords);
-}
-if(historyRecords!=null){
-mock.historyRecords.addAll(historyRecords);
-}
-repo=mock;
-}else{
-repo=(IHistoryRepository)fallback;
-}
-returnrepo;
+if(shouldUseMock(sObjectType)){
+returncreateMockRepo(sObjectType,repoFactory);
+}
+return(IHistoryRepository)fallback;
@@ -105,0 +69,41 @@
+}
+privatestaticStringgetRelationshipName(SObjectrecord,Schema.SObjectFieldchildField){
+List<Schema.ChildRelationship>childRelationships=getChildRelationships(record.getSObjectType());
+for(Schema.ChildRelationshipchildRelationship:childRelationships){
+if(childRelationship.getField()==childField){
+returnchildRelationship.getRelationshipName();
+}
+}
+returnnull;
+}
+privatestaticList<Schema.ChildRelationship>getChildRelationships(Schema.SObjectTypesObjectType){
+List<Schema.ChildRelationship>childRelationships=CACHED_CHILD_RELATIONSHIPS.get(sObjectType);
+if(childRelationships==null){
+childRelationships=sObjectType.getDescribe(Schema.SObjectDescribeOptions.FULL).getChildRelationships();
+CACHED_CHILD_RELATIONSHIPS.put(sObjectType,childRelationships);
+}
+returnchildRelationships;
+}
+privatestaticSObjectappendChildren(SObjectrecord,StringrelationshipName,List<SObject>children){
+StringserializedMeta=JSON.serialize(record).removeEnd('}');
+StringchildrenJson='"'+relationshipName+'":'+JSON.serialize(newChildrenSObjects(children));
+serializedMeta+=','+childrenJson+'}';
+return(SObject)JSON.deserialize(serializedMeta,SObject.class);
+}
+privatestaticBooleanshouldUseMock(Schema.SObjectTypesObjectType){
+returngetResults(sObjectType).isEmpty()==false||
+(AggregateResults.get(sObjectType)!=null&&AggregateResults.get(sObjectType).isEmpty()==false)||
+(HistoryResults.get(sObjectType)!=null&&HistoryResults.get(sObjectType).isEmpty()==false)||
+(CursorResults.get(sObjectType)!=null&&CursorResults.get(sObjectType).isEmpty()==false)||
+alwaysUseMock==true;
+}
+privatestaticRepoMockcreateMockRepo(Schema.SObjectTypesObjectType,RepoFactoryrepoFactory){
+RepoMockmock=newRepoMock(sObjectType,repoFactory);
+mock.results.addAll(getResults(sObjectType));
+if(AggregateResults.get(sObjectType)!=null){
+mock.aggRecords.addAll(AggregateResults.get(sObjectType));
+}
+if(HistoryResults.get(sObjectType)!=null){
+mock.historyRecords.addAll(HistoryResults.get(sObjectType));
+}
+returnmock;

--- backup/repository\AggregateRepository.cls
+++ refactored/repository\AggregateRepository.cls
@@ -138,6 +138,2 @@
-if(this.groupedByFieldNames.isEmpty()==false){
-StringpotentialOrderBy=null;
-StringorderByKey='\nORDERBY';
-if(baseString.contains(orderByKey)){
-potentialOrderBy=baseString.substringAfter(orderByKey);
-baseString=baseString.replace(orderByKey+potentialOrderBy,'');
+if(this.groupedByFieldNames.isEmpty()){
+returnbaseString;
@@ -145,13 +141 @@
-baseString+='\nGROUPBY';
-for(GroupBygroupBy:this.groupedByFieldNames){
-baseString+=groupBy.getGroupByName()+',';
-}
-baseString=baseString.removeEnd(',');
-if(this.havingFields.isEmpty()==false){
-baseString+='\nHAVING'+String.join(this.havingFields,',');
-}
-if(potentialOrderBy!=null){
-baseString+=orderByKey+potentialOrderBy;
-}
-}
-returnbaseString;
+returnthis.applyGroupBy(baseString);
@@ -163,0 +148,24 @@
+}
+privateStringapplyGroupBy(StringbaseString){
+StringworkingString=baseString;
+StringpotentialOrderBy=null;
+StringorderByKey='\nORDERBY';
+if(workingString.contains(orderByKey)){
+potentialOrderBy=workingString.substringAfter(orderByKey);
+workingString=workingString.replace(orderByKey+potentialOrderBy,'');
+}
+workingString+='\nGROUPBY'+this.getGroupByClause();
+if(this.havingFields.isEmpty()==false){
+workingString+='\nHAVING'+String.join(this.havingFields,',');
+}
+if(potentialOrderBy!=null){
+workingString+=orderByKey+potentialOrderBy;
+}
+returnworkingString;
+}
+privateStringgetGroupByClause(){
+Stringclause='';
+for(GroupBygroupBy:this.groupedByFieldNames){
+clause+=groupBy.getGroupByName()+',';
+}
+returnclause.removeEnd(',');

--- backup/repository\Query.cls
+++ refactored/repository\Query.cls
@@ -189,4 +189 @@
-StringstartingString=this.toString();
-for(Stringkey:this.bindVars.keySet()){
-startingString=startingString.replace(':'+key,this.getSoslPredicate(this.bindVars.get(key)));
-}
+StringstartingString=this.replaceBindVars(this.toString());
@@ -194,19 +191 @@
-Iterable<Object>localPredicate=(Iterable<Object>)this.predicate;
-if(localPredicate.iterator().hasNext()==false){
-return'';
-}
-StringoperatorToReplace;
-StringnewOperator;
-switchonthis.operator{
-whenEQUALS{
-operatorToReplace='=';
-newOperator='IN';
-}
-whenNOT_EQUALS{
-operatorToReplace='!=';
-newOperator='NOTIN';
-}
-}
-if(operatorToReplace!=null){
-startingString=startingString.replace(operatorToReplace,newOperator);
-}
+startingString=this.handleIterablePredicate(startingString);
@@ -282,0 +262,29 @@
+privateStringreplaceBindVars(StringbaseString){
+Stringresult=baseString;
+for(Stringkey:this.bindVars.keySet()){
+result=result.replace(':'+key,this.getSoslPredicate(this.bindVars.get(key)));
+}
+returnresult;
+}
+privateStringhandleIterablePredicate(StringcurrentString){
+Iterable<Object>localPredicate=(Iterable<Object>)this.predicate;
+if(localPredicate.iterator().hasNext()==false){
+return'';
+}
+StringoperatorToReplace;
+StringnewOperator;
+switchonthis.operator{
+whenEQUALS{
+operatorToReplace='=';
+newOperator='IN';
+}
+whenNOT_EQUALS{
+operatorToReplace='!=';
+newOperator='NOTIN';
+}
+}
+if(operatorToReplace!=null){
+returncurrentString.replace(operatorToReplace,newOperator);
+}
+returncurrentString;
+}
@@ -286,6 +294,14 @@
-}elseif(predicateinstanceofDatetime){
-Datetimedt=(Datetime)predicate;
-returndt.format('yyyy-MM-dd\'T\'HH:mm:ss\'Z\'','GreenwichMeanTime');
-}elseif(predicateinstanceofIterable<Object>){
-Iterable<Object>localPredicates=(Iterable<Object>)predicate;
-if(localPredicates.iterator().hasNext()==false){
+}
+if(predicateinstanceofDatetime){
+return((Datetime)predicate).format('yyyy-MM-dd\'T\'HH:mm:ss\'Z\'','GreenwichMeanTime');
+}
+if(predicateinstanceofIterable<Object>){
+returnthis.formatIterableSoslPredicate((Iterable<Object>)predicate);
+}
+if(predicateinstanceofString){
+return'\''+String.escapeSingleQuotes((String)predicate)+'\'';
+}
+returnString.valueOf(predicate);
+}
+privateStringformatIterableSoslPredicate(Iterable<Object>predicates){
+if(predicates.iterator().hasNext()==false){
@@ -295,14 +311,6 @@
-for(ObjectinnerPred:localPredicates){
-StringinnerString=this.getSoslPredicate(innerPred);
-innerStrings.add(innerString);
-}
-Stringstart='(';
-Stringending=')';
-returnstart+String.join(innerStrings,',')+ending;
-}elseif(predicateinstanceofString){
-Stringinput=(String)predicate;
-return'\''+String.escapeSingleQuotes(input)+'\'';
-}
-returnString.valueOf(predicate);
-}
-}
+for(ObjectinnerPred:predicates){
+innerStrings.add(this.getSoslPredicate(innerPred));
+}
+return'('+String.join(innerStrings,',')+')';
+}
+}

--- backup/repository\Repository.cls
+++ refactored/repository\Repository.cls
@@ -173,0 +174,58 @@
+StringrelationshipName=this.childToRelationshipNames.get(childFieldToken);
+StringchildFieldsToAdd=this.buildChildQuery(
+childFieldToken,
+relationshipName,
+childFields,
+optionalWhereFilters,
+fieldToSortOrder,
+limitBy
+);
+this.relationshipNameToChildQuery.put(relationshipName,childFieldsToAdd);
+returnthis;
+}
+publicRepositorysetAccessLevel(System.AccessLevelaccessLevel){
+this.setOptions(null,accessLevel);
+returnthis;
+}
+publicRepositoryclearBindVars(){
+for(Stringkey:this.bindVars.keySet()){
+if(this.childBindVarKeys.contains(key)==false){
+this.bindVars.remove(key);
+}
+}
+returnthis;
+}
+publicRepositorysetShouldPrintBindVars(BooleanshouldPrintBindVars){
+this.shouldPrintBindVars=shouldPrintBindVars;
+returnthis;
+}
+protectedvirtualSet<String>addSelectFields(){
+this.baseSelectUsed=true;
+returnthis.addSelectFields(this.queryFields);
+}
+protectedvirtualStringgetFinalQuery(List<Query>queries){
+returnthis.getSelectAndFrom()+
+this.addWheres(queries)+
+this.getOrderBys(this.fieldToSortOrder)+
+this.getLimitAmount(this.limitAmount);
+}
+protectedvirtualvoidclearState(){
+this.clearBindVars();
+this.fieldToSortOrder.clear();
+this.limitAmount=null;
+}
+privateStringbuildChildQuery(
+Schema.SObjectFieldchildFieldToken,
+StringrelationshipName,
+List<QueryField>childFields,
+List<Query>optionalWhereFilters,
+Map<String,RepositorySortOrder>fieldToSortOrder,
+IntegerlimitBy
+){
+Set<String>childFieldNames=newSet<String>{'Id'};
+for(QueryFieldchildField:childFields){
+childFieldNames.add(childField.toString());
+}
+for(Queryquery:optionalWhereFilters){
+this.childBindVarKeys.addAll(query.getBindVars().keySet());
+}
@@ -180,45 +238 @@
-Set<String>childFieldNames=newSet<String>{'Id'};
-for(QueryFieldchildField:childFields){
-childFieldNames.add(childField.toString());
-}
-for(Queryquery:optionalWhereFilters){
-this.childBindVarKeys.addAll(query.getBindVars().keySet());
-}
-StringrelationshipName=this.childToRelationshipNames.get(childFieldToken);
-StringchildFieldsToAdd=String.format(
-baseSubselect,
-newList<String>{String.join(childFieldNames,','),this.childToRelationshipNames.get(childFieldToken)}
-);
-this.relationshipNameToChildQuery.put(relationshipName,childFieldsToAdd);
-returnthis;
-}
-publicRepositorysetAccessLevel(System.AccessLevelaccessLevel){
-this.setOptions(null,accessLevel);
-returnthis;
-}
-publicRepositoryclearBindVars(){
-for(Stringkey:this.bindVars.keySet()){
-if(this.childBindVarKeys.contains(key)==false){
-this.bindVars.remove(key);
-}
-}
-returnthis;
-}
-publicRepositorysetShouldPrintBindVars(BooleanshouldPrintBindVars){
-this.shouldPrintBindVars=shouldPrintBindVars;
-returnthis;
-}
-protectedvirtualSet<String>addSelectFields(){
-this.baseSelectUsed=true;
-returnthis.addSelectFields(this.queryFields);
-}
-protectedvirtualStringgetFinalQuery(List<Query>queries){
-returnthis.getSelectAndFrom()+
-this.addWheres(queries)+
-this.getOrderBys(this.fieldToSortOrder)+
-this.getLimitAmount(this.limitAmount);
-}
-protectedvirtualvoidclearState(){
-this.clearBindVars();
-this.fieldToSortOrder.clear();
-this.limitAmount=null;
+returnString.format(baseSubselect,newList<String>{String.join(childFieldNames,','),relationshipName});